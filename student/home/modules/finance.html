<style>
    .division-container:hover .division-bar p {
        color: rgba(255, 255, 255, 0.85);
        transition: 200ms color ease-out;
    }

    .division-bar {
        max-width: 40px !important;
    }

    .division-bar p {
        color: transparent;
        font-weight: bold;
        font-size: 8pt;
        transition: 1500ms color ease-out;
    }

    .division-bar-first {
        border-radius: 5px 5px 0 0;
    }

    .division-bar-last {
        border-radius: 0 0 5px 5px;
    }

    .division-text div {
        border-bottom: 1px solid var(--sys-gray4);
    }

    .transaction-container {
        padding-top: 22px;
    }

    .goal {
        max-height: 45px;
        overflow-y: hidden
    }

    .large-icon {
        --ionicon-stroke-width: 40px;
        font-size: 40pt
    }

    .input-tag {
        color: #fff;
        padding: 2px 0 2px 11px;
        min-width: 40px;
        width: auto;
        font-size: 11pt;
    }

    @media only screen and (max-width: 575px) {
        .transaction-container {
            padding-top: 270px;
        }

        .division-container .division-bar p {
            color: rgba(255, 255, 255, 0.75);
            transition: 200ms color ease-out;
        }
    }
</style>
<div class="h-100" style="overflow-x: hidden">
    <div class="sticky-top" style="z-index: 1; background-color: var(--bg-content)">
        <div class="d-flex pt-3 px-1 justify-content-end sticky-top">
            <div class="d-flex px-2">
                <div class="pe-2">
                    <div class="icon-button" onclick="toggleAddUI()">
                        <ion-icon style="color: var(--bg-content);" name="flash-outline"></ion-icon>
                    </div>
                </div>
                <div id="transactionButton" class="pe-2">
                    <div class="icon-button" onclick="toggleAddUI()">
                        <ion-icon name="add-outline"></ion-icon>
                    </div>
                </div>
                <div id="goalButton" class="pe-2">
                    <div class="icon-button" onclick="toggleGoalUI()">
                        <ion-icon name="flag-outline"></ion-icon>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex pt-2 px-3 px-md-5" style="color: var(--sys-green)">
            <h2 style="font-weight: bold;">Finanzen</h2>
        </div>
    </div>
    <div class="ps-3 px-md-5" style="height: 90%; overflow-y: auto;">

        <div class="w-100 h-100">
            <div class="w-100 row">
                <div id="transactionCreate" class="col-12 pb-5 top-left-flyIn display-none">
                    <div class="p-3" style="

                    background: linear-gradient(var(--sys-gray6), var(--sys-gray6)) padding-box,
                    linear-gradient(140deg, rgba(99,230,226,1) 0%, rgba(93,188,251,1) 21%, rgba(43,227,131,1) 58%, rgba(246,200,51,1) 100%) border-box;
                    border-radius: 10px;
                    border: 4px solid transparent;">

                        <h4>Neue Transaktion</h4>
                        <div class="w-100 row d-flex justify-content-between px-1">
                            <div class="col-4 col-xl-2 skipThrough" data-index="1">
                                <input id="transactionCreateValue" class="createInput skipThroughd" style="font-size: 13pt;"
                                       placeholder="Betrag" type="text" data-index="1" oninput="validForm()">
                            </div>
                            <div class="col-8 col-xl-7 px-2 skipThrough">
                                <input id="transactionCreateTitle" class="createInput" style="font-size: 13pt;"
                                       placeholder="Titel" type="text" data-index="2" oninput="validForm()">
                                <input id="transactionCreateDescription" class="createInput pb-2" style="font-size: 13pt;"
                                       placeholder="Beschreibung" type="text" data-index="3" oninput="validForm()">
                                <input id="transactionCreateTag" class="createInput input-tag" style="background-color: var(--sys-gray3);"
                                       placeholder="group" type="text" data-index="3" oninput="onCreateTagInput(); validForm()">
                            </div>
                            <div class="col-12 col-xl-3 skipThrough">
                                <input id="transactionCreateHappened" class="createInput" style="white-space: nowrap; font-size: 13pt;"
                                       value="" type="datetime-local" data-index="4" oninput="validForm()">
                            </div>
                            <div class="col-6 pt-3 skipThrough">
                                <a class="actionText" onclick="toggleAddUI()">Cancel</a>
                            </div>
                            <div class="col-6 pt-3 d-flex align-items-end justify-content-end skipThrough">
                                <a class="actionText pb-1" onclick="createTransaction()" style="font-weight: 500" data-index="4">Fertig</a>
                                <div class="icon-button">
                                    <ion-icon id="iconValidate" class="icon-validate" name="close-circle-outline" style="color: var(--sys-red)"></ion-icon>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="goalSet" class="col-12 pb-5 opacity-fadeIn display-none">
                    <div class="p-3" style="background: var(--sys-gray6);border-radius: 10px;">
                        <h4>Neues Ziel setzen</h4>
                        <div class="w-100 row d-flex justify-content-between px-1">
                            <div class="col-12">
                                <input id="goalValue" class="createInput skipThroughd" style="font-size: 13pt;"
                                       placeholder="Ziel" type="text">
                            </div>
                            <div class="col-6 pt-3">
                                <a class="actionText" onclick="toggleGoalUI()">Cancel</a>
                            </div>
                            <div class="col-6 pt-3 d-flex align-items-end justify-content-end">
                                <a class="actionText pb-1" onclick="setGoal()" style="font-weight: 500">Ändern</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-xl-5 p-sm-0 pe-md-3">
                    <div class="row h-100">
                        <div class="col-12 col-xl-6">
                            <div class="d-flex align-content-center justify-content-end">
                                <div class="opacity-fadeIn">
                                    <h2 class="m-0" style="white-space: nowrap; font-size: 30pt; font-weight: 600;"><span id="totalMoney">0 €</span></h2>
                                    <p class="text-end text-secondary">Kasse Insgesamt</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-xl-6 opacity-fadeIn">
                            <div class="ps-0 ps-xl-3">
                                <div id="trendContainer" class="p-3 h-100" style="border-radius: 10px; background-color: var(--sys-gray6);">
                                    <h5>Trend</h5>
                                    <div class="d-flex align-items-center justify-content-center">
                                        <ion-icon id="trendIcon" class="large-icon" style="color: var(--sys-gray3);" name="infinite-outline"></ion-icon>
                                        <div id="trend" class="ps-3" style="color: var(--sys-gray); max-height: 45px; overflow-y: hidden">
                                            kein Trend erkannt
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="ps-0 ps-xl-3 pt-2">
                                <div id="goalContainer" class="p-3" style="border-radius: 10px; background-color: var(--sys-gray6);">
                                    <h5>Goal</h5>
                                    <div class="d-flex align-items-center justify-content-center">
                                        <ion-icon id="goalIcon" class="large-icon" style="color: var(--sys-gray3);" name="flag-outline"></ion-icon>
                                        <div id="goal" class="ps-3 goal" style="color: var(--sys-gray);">
                                            Ziel lädt...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-7 pt-sm-3 pt-xl-0" style="min-height: 250px;">
                    <div class="row" style="height: 250px">
                        <div class="order-1 order-sm-0 col-12 col-sm-4 pt-3 pt-sm-0 p-sm-0 h-100">
                            <div class="p-3 h-100 division-container" style="overflow-y: hidden; border-radius: 10px; background-color: var(--sys-gray6);">
                                <h5>Einnahmen</h5>
                                <div class="h-100 opacity-fadeIn" style="overflow-x: hidden; min-width: 140px !important; max-width: 350px">
                                    <div id="incomes" class="px-3 row row-cols-2" style="height: 70% !important;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="order-0 order-sm-1 col-12 col-sm-8 pt-3 pt-sm-0 h-100">
                            <div class="p-3 h-100" style="border-radius: 10px; background-color: var(--sys-gray6);">
                                <h5>Wochenübersicht</h5>
                                <div class="pt-2 m-2">
                                    <div class="ct-chart ct-major-sixth"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 transaction-container">
                    <h5>Transaktionen</h5>
                    <div class="pt-2 pb-5" id="transactions"></div>
                </div>
            </div>
        </div>

        <div id="notFound" class="display-none" style="height: 90%; display: flex; align-items: center; justify-content: center">
            <div>
                <div class="d-flex justify-content-center align-content-center">
                    <ion-icon style="font-size: 55px; color: var(--sys-red)" name="alert-circle-outline"></ion-icon>
                </div>
                <h4 id="notFoundText" class="text-center">Etwas ist schiefgelaufen!</h4>
                <p id="notFoundDescription" class="text-center" style="font-size: large; color: var(--sys-gray)">Bitte probiere es zu einem späteren Zeitpunkt</p>
            </div>
        </div>
    </div>
</div>

<script id="moduleScript">
    /**
     * JQuery reacting to keyboard to skip through login
     */
    $(".skipThrough").on('keydown', 'input', function (event) {
        if (event.which === 13) {
            event.preventDefault();
            let $this = $(event.target);
            let index = parseFloat($this.attr('data-index'));
            $('[data-index="' + (index + 1) + '"]').focus().click();
        }
    });

    var tags = {};

    var valueNowDate = new Date()
    valueNowDate.setMinutes(valueNowDate.getMinutes() - valueNowDate.getTimezoneOffset())
    $("#transactionCreateHappened").val(valueNowDate.toISOString().slice(0, 16));

    var tagColors = ["blue", "indigo", "purple", "pink", "red", "cyan", "green", "brown"];

    getAccount()

    function getAccount() {
        return new Promise(function (resolve, reject) {
            api("/student/finance/transactions", "GET", null)
                .then(value => {
                    loadUI(value.data)
                    animateStop("contentView")
                    resolve(value.data);
                })
                .catch(error => {
                    console.debug(error)
                    animateError("contentView")
                    reject(value);
                })
        })
    }

    function getStudents() {
        return new Promise(function (resolve, reject) {
            api("/student/students", "GET", null)
                .then(value => {
                    animateStop("contentView")
                    resolve(value.data)
                })
                .catch(error => {
                    animateError("contentView")
                    reject(error);
                })
        })
    }

    function setGoal() {
        let val = parseFloat($("#goalValue").val().replaceAll(",", "."));
        return new Promise(function (resolve, reject) {
            api(`/student/finance/goal/${val}`, "POST", null)
                .then(value => {
                    // hide goal set ui
                    $("#goalSet").addClass("display-none");
                    $("#goalValue").val("")

                    // reload UI with new data
                    loadUI(value.data);
                    resolve(value);
                })
                .catch(error => {
                    console.error(error);
                    animateLoadByType("contentView", "100%", "dots");
                    animateError("contentView");
                    reject(error);
                })
        });
    }

    function createTransaction() {
        if (!validForm()) return;
        return new Promise(function (resolve, reject) {
            api("/student/finance/create", "POST", JSON.stringify({
                "money": parseFloat($("#transactionCreateValue").val().replaceAll(",", ".")),
                "title": $("#transactionCreateTitle").val(),
                "description": $("#transactionCreateDescription").val(),
                "tag": $("#transactionCreateTag").val(),
                "happened": new Date($("#transactionCreateHappened").val()).toISOString()
            }))
                .then(value => {
                    // reset and close
                    $("#transactionCreateValue").val("")
                    $("#transactionCreateTitle").val("")
                    $("#transactionCreateDescription").val("")
                    $("#transactionCreateTag").val("").attr("style", `background-color: var(--sys-gray3);`)
                    $("#transactionCreate").addClass("display-none")

                    // refresh UI with new data
                    loadUI(value)
                    resolve(value);
                })
                .catch(error => {
                    console.error(error);
                    animateLoadByType("contentView", "100%", "dots");
                    animateError("contentView")
                    reject(error)
                })
        });
    }

    function validForm() {
        let value = $("#transactionCreateValue").val().replaceAll(",", "."),
            title = $("#transactionCreateTitle").val(),
            description = $("#transactionCreateDescription").val(),
            tag = $("#transactionCreateTag").val(),
            happened = $("#transactionCreateHappened").val(),
            icon = $("#iconValidate"),
            valid = true;

        if (parseFloat(value)<1 || value==="") valid = false;
        if (title.length<2) valid = false;
        if (description.length<2) valid = false;
        if (tag.length<2) valid = false;
        if (new Date(happened).getTime()<5) valid = false;

        valid ? icon.attr("style", "color: var(--sys-green)").attr("name", "checkmark-circle-outline"):
            icon.attr("style", "color: var(--sys-red)").attr("name", "close-circle-outline");
        return valid;
    }

    function toggleAddUI() {
        let tsCreate = $("#transactionCreate");
        $("#goalSet").addClass("display-none");
        tsCreate.hasClass("display-none") ? tsCreate.removeClass("display-none") : tsCreate.addClass("display-none");
    }

    function toggleGoalUI() {
        let goCreate = $("#goalSet");
        $("#transactionCreate").addClass("display-none");
        goCreate.hasClass("display-none") ? goCreate.removeClass("display-none") : goCreate.addClass("display-none");
    }

    function onCreateTagInput() {
        let tag = $("#transactionCreateTag");

        if (Object.keys(tags).includes(tag.val())) tag.attr("style",
            `background-color: var(--sys-${tags[tag.val()]["color"]}); width: ${((tag.val().length + 1) * 8)  + 20 +'px'}`);
        else tag.attr("style", `background-color: var(--sys-gray3); width: ${((tag.val().length + 1) * 8) + 20 +'px'}`);
    }

    function loadUI(value) {

        identity.permissions["finance.set.goal"] ? $("#goalButton") : $("#goalButton").addClass("display-none");
        identity.permissions["finance.set.goal"] ? $("#transactionButton") : $("#transactionButton").addClass("display-none");

        getStudents().then(student => {
            // reset
            $("#transactions").html("")
            $("#incomes").html(`<div class="division-text col-10 col-md-9 col-xxl-10 order-2 d-flex align-items-end">
                                            <div class="w-100">
                                                <p class="m-0">Andere</p>
                                            </div>
                                        </div>
                                        <div id="others" class="division-bar division-bar-last col-2 col-md-3 col-xxl-2 order-1 d-flex align-items-end align-content-end justify-content-center">
                                            <p class="text-center m-0" id="othersText">lädt...</p>
                                        </div>`)

            // var for this execute
            let goal = value["data"]["goal"],
                totalMoney = 0.0,
                trend = 0.0,
                weeks = [],
                transactions = value["data"]["transactions"];

            // Build transactions
            let lastHappened = 0;
            for (let i=0; i < transactions.length; i++) {
                let transaction = transactions[i],
                    money = transaction["money"],
                    moneyPrefix = money < 0 ? "" : "+",
                    moneyColor = money < 0 ? "red" : "green",
                    title = transaction["title"],
                    description = transaction["description"],
                    tag = transaction["tag"],
                    created = new Date(transaction["created"]),
                    happened = new Date(transaction["happened"]),
                    studentName = student[transaction["studentId"]]["name"]["firstname"]+" "
                        +student[transaction["studentId"]]["name"]["lastname"];

                let year = new Date(happened.getFullYear(), 0, 1);
                let days = Math.floor((happened - year) / (24 * 60 * 60 * 1000));
                let week = Math.ceil((happened.getDay() + 1 + days) / 7);
                if (isset(weeks[week])) {
                    if (money>=0) weeks[week]["pos"] += money;
                    else weeks[week]["neg"] += money;
                } else {
                    weeks[week] = {"pos": 0, "neg": 0};
                    if (money>=0) weeks[week]["pos"] = money;
                    else weeks[week]["neg"] = money;
                }

                // tag handling
                if (!isset(tags[tag])) {
                    if (tag==="Andere") {
                        tags[tag] = {"money": money, "color": "orange"}
                    } else {
                        tags[tag] = {"money": money, "color": tagColors[i]}
                    }
                } else {
                    tags[tag]["money"] += money;
                }

                // calculate money
                totalMoney += transaction["money"];

                // trend
                if (happened.getTime() > 0) {
                    trend = money / totalMoney;

                    lastHappened = happened.getTime();
                }

                // generate transaction note
                $("#transactions").append(`
            <div class="w-100 d-flex pb-3" data-sort-created="${created.getTime()}">
                            <div>
                                <p style="color: var(--sys-${moneyColor}); white-space: nowrap; font-size: 12pt; min-width: 110px">
                                    ${moneyPrefix}${currency.format(money)}
                                </p>
                            </div>
                            <div class="w-100 row row-cols-2">
                                <div class="col-12 col-sm-8">
                                    <h6>${title}</h6>
                                    <p>${description}</p>
                                </div>
                                <div class="col-12 col-sm-4 d-flex justify-content-sm-end">
                                    <div>
                                        <p class="pb-3 m-0"><span class="p-1" style="background: var(--sys-${tags[tag]["color"]});
                                        border-radius: 8px; color: #fff; opacity: 0.9 ">${tag}</span></p>
                                        <p class="m-0" style="font-size: 10pt; color: var(--sys-gray)">Erstellt: <span style="font-size: 11pt; color: var(--sys-black);">${timeToString(created)}</span></p>
                                        <p class="m-0" style="font-size: 10pt; color: var(--sys-gray)">Stattgefunden: <span style="font-size: 11pt; color: var(--sys-black);">${timeToString(happened)}</span></p>
                                        <p class="m-0" style="font-size: 10pt; color: var(--sys-gray)">Autorisiert: <span style="font-size: 11pt; color: var(--sys-black);">${studentName}</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>`);
            }
            // sort descending from created date
            sortChildrenAttr("transactions", "data-sort-created", false);

            // goal display
            if (totalMoney < goal) {
                $("#goalContainer").attr("style", "border-radius: 10px; background-color: var(--sys-gray6);")
                $("#goalIcon").attr("style", "color:var(--sys-orange)")
                $("#goal").html(`
                    <span style="color: var(--sys-orange)">
                        ${currency.format(goal-totalMoney)}</span> bis zum Ziel
                    <span style="color: var(--sys-orange)">
                        ${currency.format(goal)}</span>`)

            } else {
                $("#goalContainer").attr("style", "border-radius: 10px; background-color: var(--sys-green); color: #fff !important")
                $("#goalIcon").attr("style", "color:currentColor")
                $("#goal").html(`<span style="color: #fff; font-weight: bold">${currency.format(goal)} erreicht!</span>`)
            }

            // trend
            if (trend!==0) {
                let trendColor = trend > 0 ? "--sys-green" : "--sys-red",
                    trendIcon = trend > 0 ? "trending-up-outline" : "trending-down-outline";
                $("#trendIcon").attr("style", `color: var(${trendColor})`).attr("name", trendIcon)
                $("#trend").html(`<span style="color: var(${trendColor});">${percentage.format(trend)}</span> durch letzte Transaktion`)
            }


            let incomeTags = {},
                incomeTagsTotalMoney = 0;

            // find positive tags to list in income
            for (let tagsKey in tags) {
                let tag = tags[tagsKey];
                if (tag["money"]>0) {
                    incomeTags[tagsKey] = tag;
                    incomeTagsTotalMoney += tag["money"];
                }
            }

            // set percentage
            let othersPercentage = 0,
                first = true;
            for (let incomeTagsKey in incomeTags) {
                let incomeTag = incomeTags[incomeTagsKey],
                    percentage = Math.round((incomeTag["money"] / incomeTagsTotalMoney) * 100);

                if (percentage < 10 || incomeTagsKey==="Andere") {
                    othersPercentage += (incomeTag["money"] / incomeTagsTotalMoney);
                    continue;
                }

                $("#incomes").append(`<div class="division-bar ${first ? "division-bar-first" : ""} col-4 col-md-3 col-xxl-2 d-flex align-items-end align-content-end justify-content-center" style="background-color: var(--sys-${incomeTag["color"]}); min-height: ${percentage}% !important;">
                                            <p class="text-center m-0">${percentage}%</p>
                                        </div>
                                        <div class="division-text col-10 col-md-9 col-xxl-10 d-flex align-items-end">
                                            <div class="w-100">
                                                <p class="m-0">${incomeTagsKey}</p>
                                            </div>
                                        </div>`)
                first=false;
            }
            // set others percentage
            $("#others").attr("style", `background-color: var(--sys-orange); min-height: ${othersPercentage*100}% !important`)
            $("#othersText").text(`${Math.round(othersPercentage*100)}%`)



            // total money display
            $("#totalMoney").text(currency.format(totalMoney));






            var seq=0;

            let chartLabel = [];
            let chartSeriesPos = [];
            let chartSeriesNeg = [];
            Object.keys(weeks).forEach(weekKey => {
                chartLabel.push(weekKey);
                chartSeriesPos.push(weeks[weekKey]["pos"])
                chartSeriesNeg.push(weeks[weekKey]["neg"])
            })

            new Chartist.Bar('.ct-chart', {
                labels: chartLabel,
                series: [chartSeriesPos, chartSeriesNeg]
            }, {
                // Options for X-Axis
                axisX: {
                    // Allows you to correct label positioning on this axis by positive or negative x and y offset.
                    labelOffset: {
                        x: 0,
                        y: 10
                    },
                    // Interpolation function that allows you to intercept the value from the axis label
                    labelInterpolationFnc: function (value) {
                        return `KW${value}`
                    },
                    // Set the axis type to be used to project values on this axis. If not defined, Chartist.StepAxis will be used for the X-Axis, where the ticks option will be set to the labels in the data and the stretch option will be set to the global fullWidth option. This type can be changed to any axis constructor available (e.g. Chartist.FixedScaleAxis), where all axis options should be present here.
                    type: undefined,
                    // This value specifies the minimum height in pixel of the scale steps
                    scaleMinSpace: 20,
                    // Use only integer values (whole numbers) for the scale steps
                    onlyInteger: false
                },
                // Options for Y-Axis
                axisY: {
                    // Allows you to correct label positioning on this axis by positive or negative x and y offset.
                    labelOffset: {
                        x: 6,
                        y: 8
                    },
                    // Interpolation function that allows you to intercept the value from the axis label
                    labelInterpolationFnc: function (value) {
                        return Math.floor(value*10)/10 +"€"
                    },
                    // Set the axis type to be used to project values on this axis. If not defined, Chartist.AutoScaleAxis will be used for the Y-Axis, where the high and low options will be set to the global high and low options. This type can be changed to any axis constructor available (e.g. Chartist.FixedScaleAxis), where all axis options should be present here.
                    type: undefined,
                    // This value specifies the minimum height in pixel of the scale steps
                    scaleMinSpace: 20,
                    // Use only integer values (whole numbers) for the scale steps
                    onlyInteger: false
                },
                // Specify a fixed width for the chart as a string (i.e. '100px' or '50%')
                width: "100%",
                // Specify a fixed height for the chart as a string (i.e. '100px' or '50%')
                height: "auto",
                // If the line should be drawn or not
                showLine: true,
                // If dots should be drawn or not
                showPoint: false,
                // set area
                showArea: true,
                // The base for the area chart that will be used to close the area shape (is normally 0)
                areaBase: 0,
                // Specify if the lines should be smoothed. This value can be true or false where true will result in smoothing using the default smoothing interpolation function Chartist.Interpolation.cardinal and false results in Chartist.Interpolation.none. You can also choose other smoothing / interpolation functions available in the Chartist.Interpolation module, or write your own interpolation function. Check the examples for a brief description.
                lineSmooth: true,
                // Padding of the chart drawing area to the container element and labels as a number or padding object {top: 5, right: 5, bottom: 5, left: 5}
                chartPadding: {
                    top: 11,
                    right: 0,
                    bottom: 0,
                    left: 0
                },
                // When set to true, the last grid line on the x-axis is not drawn and the chart elements will expand to the full available width of the chart. For the last label to be drawn correctly you might need to add chart padding or offset the last label with a draw event handler.
                fullWidth: true,
            }, []).on('draw', function(data) {
                if (seq>data.maximum) seq=0;
                if(data.type === 'bar') {
                    data.element.animate({
                        opacity: {
                            begin: data.index * 60,
                            dur: 900,
                            from: 0,
                            to: 1,
                            easing: Chartist.Svg.Easing.easeOutQuint
                        }
                    });
                }
            });
        })

    }

    //TODO: get finance and build with loadUI
    //animateStop("contentView")
</script>
