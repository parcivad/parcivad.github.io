<style>
    .content ion-icon {
        color: var(--sys-gray);
        font-size: 22px;
    }

    .icon-button {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .icon-button:hover {
        background-color: var(--sys-gray6);
        border-radius: 6px;
    }

    .searchBar {
        background: url("/img/icons/search.png") no-repeat 5px 5px;
        background-size: 15px;
        width: 300px;
        height: 28px;
        color: var(--sys-black);
        font-size: 10pt;
        font-style: var(--sys-gray6);
        padding-left: 28px;
        border-radius: 6px;
        border: 1px solid var(--sys-gray6);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .searchBar:focus {
        background-color: var(--sys-gray6);
    }

    @media only screen and (max-width: 720px) {
        .searchBar {
            width: 150px;
        }
    }

    @media (prefers-color-scheme: dark) {
        .searchBar {
            background: url("/img/icons/search.dark.png") no-repeat 5px 5px;
            background-size: 15px;
        }
    }

    .courseItem {
        background: var(--sys-gray6);
        border-radius: 8px;
    }
</style>
<div class="h-100" style="overflow-x: hidden">
    <!-- Header -->
    <div class="sticky-top" style="z-index: 1; background-color: var(--bg-content)">
        <div class="d-flex pt-3 px-1 justify-content-end sticky-top">
            <div class="d-flex px-2">
                <div class="pe-2">
                    <div class="icon-button" onclick="logout()"><ion-icon name="log-out-outline"></ion-icon></div>
                </div>
            </div>
        </div>
        <h2 id="name" class="pt-2 px-3 px-md-5" style="font-weight: bold; color: var(--sys-indigo)">lädt...</h2>
    </div>

    <!-- Content -->
    <div class="px-3 px-md-5" style="height: 90%; overflow-y: auto; max-width: 1050px">

        <!-- Account -->
        <h5 class="pt-2">Konto Informationen</h5>
        <div>
            <div class="pb-4">
                <div class="row row-cols-2 d-flex">

                    <p class="col-2 col-xl-1">Email</p>
                    <p id="email" class="col-10 col-xl-11 text-start text-secondary">lädt...</p>

                    <p class="col-2 col-xl-1 mt-2">Klasse</p>
                    <p id="grade" class="col-10 col-xl-11 mt-2 text-start text-secondary">lädt...</p>

                    <p class="col-2 col-xl-1 mb-xl-0 mb-1">Kurse</p>
                    <div id="courses" class="col-10 col-xl-11 row row-cols-auto px-4 px-xl-0 d-flex"></div>

                    <p class="col-12 m-0" style="color: var(--sys-gray2); font-size: 10pt">Einstellungen von deiner Klasse und
                        Kursen können nur von Moderatoren oder Administratoren verändert werden.</p>
                </div>
            </div>
        </div>

        <h5 class="pt-4">Sicherheit</h5>
        <div>
            <p class="mb-0">Rollen: <span id="roles" class="text-secondary">Schüler, Administrator</span></p>
            <p style="color: var(--sys-gray2); font-size: 10pt">Eine Rolle bestimmt deine Zugriffsrechte.</p>
        </div>

        <!-- Delete -->
        <h5 class="pt-4">Löschen</h5>
        <p class="text-danger">Durch das Klicken auf "Konto löschen" werden alle deine Daten gelöscht und du wirst
            ausgeloggt! Dein verbundener Kalender kann sich dann nicht mehr aktualisieren.</p>
        <button id="deleteButton" class="button" onclick="deleteStudent()" style="background: var(--sys-red); color: #fff">
            Konto löschen
        </button>
    </div>
</div>

<script id="moduleScript">
    getIdentity()

    var confirmDelete = false;

    function getIdentity() {
        animateLoadByType("contentView", "100%", "dots");
        api("/student/identity", "GET", null)
            .then(value => {
                loadUI(value);
                animateStop("contentView");
            })
            .catch(error => {
                console.debug(error)
                animateError("contentView");
            })
    }

    function getGradeNameById(gradeId) {
        return new Promise(function (resolve, reject) {
            call("/student/grades", "GET", null, null)
                .then(value => {
                    value.forEach(v => {
                        if (v["gradeId"] === gradeId) return resolve(v["gradeName"]);
                    })
                })
                .catch(error => {
                    reject(error);
                })
        })
    }

    function deleteStudent() {
        let button = $("#deleteButton");

        if (confirmDelete) {
            api("/student/delete", "POST", null)
                .then(value => {
                    if (value.status === 200) {
                        button.text("gelöscht")
                        logout();
                        return true;
                    }
                    button.text("Etwas ist schiefgelaufen")
                })
                .catch(error => {
                    button.text("Etwas ist schiefgelaufen")
                })

        } else {
            button.text("Konto wirklich löschen")
            confirmDelete = true;
        }
    }

    function loadUI(data) {

        $("#name").text(`${data["name"]["firstname"]} ${data["name"]["lastname"]}`)

        $("#email").text(data["email"]);
        getGradeNameById(data["gradeId"])
            .then(value => {
                $("#grade").text(value)
            })

        call(`/student/courses?gradeId=${data["gradeId"]}`, "GET", null, null)
            .then(value => {
                let target,
                    course;

                for (let i=0; i < data["courses"].length; i++) {
                    target = data["courses"][i];
                    for (let x=0; x < value.length; x++) {
                        course = value[x];
                        if (course["courseId"] === target) {
                            $("#courses").append(`<p class="col px-1"><span class="p-1 courseItem" style="color: var(--sys-gray0)">${course["courseName"]}</span></p>`)
                        }
                    }
                }
            })
            .catch(error => {
                console.debug(error);
            })

        $("#roles").text(data["roles"].toString().replaceAll("ROLE_", "").replaceAll(",", ", ").toLowerCase())
    }
</script>