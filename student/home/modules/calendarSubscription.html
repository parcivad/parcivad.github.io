<style>
    .content ion-icon {
        color: var(--sys-gray);
        font-size: 22px;
    }

    .icon-button {
        display: flex;
        width: 30px;
        height: 30px;
        cursor: pointer;
        align-items: center;
        justify-content: center;
    }

    .icon-button:hover {
        background-color: var(--sys-gray6);
        border-radius: 6px;
    }

    .setting-box {
        width: 190px;
        height: 170px;
        border-radius: 15px;
        border: 1px solid var(--sys-gray5);
        box-shadow: 0px 10px 15px -3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
    }

    .setting-box .thumbnail {
        height: 58%;
        border-radius: 15px 15px 0 0
    }

    .thumbnail-off {
        filter: grayscale(100%);
    }

    .thumbnail ion-icon {
        color: var(--sys-black);
        font-size: 70px;
    }

    .setting-box .content {
        height: 42%;
        overflow-y: hidden;
        background-color: var(--sys-gray6);
        border-radius: 0 0 15px 15px
    }

    .setting-box p {
        font-size: 10pt
    }
</style>
<div class="h-100" style="overflow-x: hidden">
    <!-- Header -->
    <div class="sticky-top" style="z-index: 1; background-color: var(--bg-content)">
        <div class="d-flex pt-3 px-1 justify-content-end sticky-top">
            <div class="d-flex px-2">
                <div class="pe-2">
                    <div class="icon-button" onclick="openICalender()"><ion-icon name="link-outline"></ion-icon></div>
                </div>
            </div>
        </div>
        <h2 class="px-3 px-md-5" style="font-weight: bold; color: var(--sys-pink)">Kalender Abonnement</h2>
    </div>

    <!-- Content -->
    <div class="px-3 px-md-5" style="height: 90%; overflow-y: auto; max-width: 1050px">
        <p class="text-secondary">Füge deinen eigenen Stundenplan nahtlos in den Apple oder Google Kalender ein.
            So kannst du auch ohne Internet deine Stunden und zugehörigen Räume einsehen, sowie deinen Klausurplan.
            Bei einer Verbindung mit dem Internet werden deine Kalendereinträge auf dem neusten Stand gehalten und
            aktualisieren sich automatisch <span style="font-style: italic">(bei Apple)</span>.</p>

        <!-- Settings -->
        <h5 class="pt-2">Einstellungen</h5>
        <div class="row row-cols-2 row-cols-md-auto pt-1">
            <div class="col">
                <div class="pt-3">
                    <div id="emoji" class="setting-box" onclick="update('emoji')">
                        <div id="emoji-thumbnail" class="d-flex thumbnail align-items-center justify-content-center" style="background: rgb(2,0,36); background: linear-gradient(347deg, rgba(2,0,36,0) 0%, rgba(9,9,121,0) 12%, rgba(0,255,154,1) 100%);">
                            <ion-icon name="dice-outline"></ion-icon>
                        </div>
                        <div class="content">
                            <div class="p-2">
                                <h6 class="mb-0">Emojis</h6>
                                <p class="text-secondary">Im Titel oder in Beschreibungen</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="pt-3">
                    <div id="alarm" class="setting-box" onclick="update('alarm')">
                        <div id="alarm-thumbnail" class="d-flex thumbnail align-items-center justify-content-center" style="background: rgb(2,0,36); background: linear-gradient(347deg, rgba(2,0,36,0) 0%, rgba(9,9,121,0) 12%, rgba(0,182,255,1) 100%);">
                            <ion-icon name="notifications-outline"></ion-icon>
                        </div>
                        <div class="content">
                            <div class="p-2">
                                <h6 class="mb-0">Alarm</h6>
                                <p class="text-secondary">Wenn Hinweise erlaubt Mitteilungen erhalten</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="pt-3">
                    <div id="status" class="setting-box" style="cursor: default">
                        <div id="status-thumbnail" class="d-flex thumbnail align-items-center justify-content-center" style="background: rgb(2,0,36); background: linear-gradient(347deg, rgba(2,0,36,0) 0%, rgba(9,9,121,0) 12%, rgba(147,74,255,1) 100%);">
                            <ion-icon name="code-download-outline"></ion-icon>
                        </div>
                        <div class="content">
                            <div class="p-2">
                                <h6 class="mb-0">Status</h6>
                                <p id="status-content" class="text-secondary">lädt...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hinzufügen -->
        <h5 class="pt-5">Abonnieren</h5>
        <p class="text-secondary">Um den Kalender erfolgreich zu abonnieren, öffne zuerst die jeweilige Kalenderapp auf
            deinem Gerät. Nachdem du auf Hinzufügen klickst, kannst du in der Kalenderapp den
            Vorgang beenden.</p>
        <button class="button" onclick="openICalender()">
            Hinzufügen
        </button>

        <!-- Tipps -->
        <h5 class="pt-5">Tipps</h5>
        <p class="text-secondary">Durch das Klicken auf einen Tipp kannst du den nächsten aufrufen.</p>
        <div>
            <div id="carouselExampleFade" class="carousel slide carousel-fade" role="button" data-bs-target="#carouselExampleFade" data-bs-slide="next">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <div class="row row-cols-1">
                            <div class="col-12 col-md-4 col-xl-6 d-flex align-items-center justify-content-center">
                                Füge ein Kalender-Widget zu deinem Sperrbildschirm hinzu, damit du immer die nächste Stunde und den nächsten Raum siehst.
                            </div>
                            <div class="col-12 col-md-8 col-xl-6 pt-3 pb-3 pt-xl-0 pb-xl-0">
                                <div class="d-flex align-items-md-center justify-content-center justify-content-xl-end">
                                    <img src="/img/studentHome/calendarSubscription/calendarAdd.png" style="width: 300px">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <div class="row row-cols-1">
                            <div class="col-12 col-md-4 col-xl-6 d-flex align-items-center justify-content-center">
                                Wenn du deinen Kalender selbst aktualisieren willst, kannst du in der Kalenderapp die Liste mit Kalendern nach unten ziehen.
                            </div>
                            <div class="col-12 col-md-8 col-xl-6 pt-3 pb-3 pt-xl-0 pb-xl-0">
                                <div class="d-flex align-items-md-center justify-content-center justify-content-xl-end">
                                    <img src="/img/studentHome/calendarSubscription/calRefresh.png" style="width: 300px">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <div class="row row-cols-1">
                            <div class="col-12 col-md-4 col-xl-6 d-flex align-items-center justify-content-center">
                                Hinweise werden nicht angezeigt? Überprüfe, ob du in den Einstellungen des hinzugefügten Kalenders Hinweise erlaubt hast.
                            </div>
                            <div class="col-12 col-md-8 col-xl-6 pt-3 pb-3 pt-xl-0 pb-xl-0">
                                <div class="d-flex align-items-md-center justify-content-center justify-content-xl-end">
                                    <img src="/img/studentHome/calendarSubscription/calDetails.png" style="width: 300px">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script id="moduleScript">
    var apiDomain = "api.parcivad.de",
        calendarData = null,
        updating = false;

    getCalendar();

    function update(id) {
        // only when update done
        if (updating) return;

        let $idObject = $(`#${id}-thumbnail`);
        if ($idObject.hasClass("thumbnail-off")) $idObject.removeClass("thumbnail-off")
        else $idObject.addClass("thumbnail-off")
        // update api
        setCalendar();
    }

    function openICalender() {
        if (calendarData === null) return;
        // open calendar
        let ua = navigator.userAgent.toLowerCase();
        let isAndroid = ua.indexOf("android") > -1; //&& ua.indexOf("mobile");
        if(isAndroid) {
            // open with google calendar
            window.location.assign(`https://calendar.google.com/calendar/u/0/r?cid=http://${apiDomain}/student/ical?calendarId=${calendarData["calendarId"].replace('"', '').replace('"', "")}`)
        } else {
            // open with apple calendar
            window.location.assign(`webcal://${apiDomain}/student/ical?calendarId=${calendarData["calendarId"].replace('"', '').replace('"', "")}`)
        }
    }

    function getCalendar() {
        animateLoadByType("contentView", "100%", "dots");
        api("/student/calendar", "GET", undefined)
            .then(value => {
                calendarData = value;
                loadUI(value);
                animateStop("contentView");
            })
            .catch(error => {
                animateError("contentView");
            })
    }

    function setCalendar() {
        updating = true;
        let body = `{"name": "${calendarData['name']}", "alarm": ${!$("#alarm-thumbnail").hasClass("thumbnail-off")}, "emoji": ${!$("#emoji-thumbnail").hasClass("thumbnail-off")}}`
        console.debug(body);
        api("/student/calendar", "POST", body)
            .then(value => {
                calendarData = value;
                loadUI(value);
                updating = false;
            })
            .catch(error => {
                console.debug(error);
            })
    }

    function loadUI(data) {
        if (data["calendarActive"]) $("#status-thumbnail").removeClass("thumbnail-off")
        else $("#status-thumbnail").addClass("thumbnail-off")

        if (data["alarm"]) $("#alarm-thumbnail").removeClass("thumbnail-off")
        else $("#alarm-thumbnail").addClass("thumbnail-off")

        if (data["emoji"]) $("#emoji-thumbnail").removeClass("thumbnail-off")
        else $("#emoji-thumbnail").addClass("thumbnail-off")

        let date = new Date(data["lastAccess"]),
            dateString = `${date.getDate()}. ${months[date.getMonth()]} ${date.getFullYear()} ${timeFormat(date.getHours())}:${timeFormat(date.getMinutes())} Uhr`;
        if (data["calendarActive"]) {
            $("#status-thumbnail").removeClass("thumbnail-off")
            $("#status-content").html(`Aktualisiert am <span style="color: var(--sys-green)">${dateString}</span>`)
        } else {
            $("#status-thumbnail").addClass("thumbnail-off")
            $("#status-content").text(`Zuletzt am ${dateString}`)
        }
    }
</script>